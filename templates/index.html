<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Round Robin</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; }
        h1, h2 { color: #2c3e50; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .settings-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .settings-row .form-group { flex: 1; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input[type="number"], input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        .process-box { 
            display: flex; 
            align-items: center;
            gap: 15px; 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 5px; 
            background: #fafafa; 
        }
        .process-id { font-weight: bold; font-size: 1.2em; color: #eb780d; min-width: 30px; }

        .btn { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background-color: #2980b9; }
        .btn-add { background-color: #27ae60; margin-bottom: 10px;}
        .btn-del { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-weight: bold;}
        
        /* GANTT */
        .gantt-container { display: flex; overflow-x: auto; margin-top: 20px; border: 1px solid #ccc; height: 80px; align-items: center; background: #fff; padding: 5px;}
        .gantt-block { display: flex; align-items: center; justify-content: center; height: 30px; color: white; font-weight: bold; position: relative; border-right: 1px solid white; flex-shrink: 0; font-size: 0.8em; }
        .gantt-cpu { background-color: #3498db; }
        .gantt-ctx { background-color: #e74c3c; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,.2) 5px, rgba(255,255,255,.2) 10px); }
        .gantt-time { position: absolute; bottom: -20px; left: 0; color: #333; font-size: 10px; }
        
        /* TABLA */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #2c3e50; color: white; }
        .summary { margin-top: 20px; font-size: 1.1em; background: #e8f6f3; padding: 15px; border-left: 5px solid #1abc9c; }

        /* TRAZA (COLA DE LISTOS) */
        .trace-wrapper { display: flex; overflow-x: auto; margin-top: 10px; padding-bottom: 10px; gap: 4px; border: 1px solid #eee; padding: 10px; background: #fff; border-radius: 5px; }
        .trace-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            min-width: 40px; height: 80px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.85em; 
            padding: 4px 0; position: relative;
        }
        
        /* Colores fases */
        .fase-0 { background-color: #3498db; } 
        .fase-2 { background-color: #e67e22; } 
        .fase-4 { background-color: #9b59b6; } 
        .fase-6 { background-color: #1abc9c; } 
        .fase-other { background-color: #34495e; } 

        .trace-top { border-bottom: 1px solid rgba(255,255,255,0.4); width: 100%; text-align: center; padding-bottom: 2px; }
        .trace-mid { flex: 1; display: flex; align-items: center; font-size: 1.2em; }
        .trace-bot { font-size: 0.8em; background: rgba(0,0,0,0.2); width: 100%; text-align: center; }

    </style>
</head>
<body>

<div class="container">
    <h1>Simulador Round Robin</h1>
    <p>Ingrese los valores en Quantums (excepto la llegada que es en ms).</p>

    <div class="settings-row">
        <div class="form-group">
            <label>Tamaño del Quantum (ms):</label>
            <input type="number" id="quantum" value="100">
        </div>
        <div class="form-group">
            <label>Tiempo de Intercambio (ms):</label>
            <input type="number" id="intercambio" value="10">
        </div>
    </div>

    <h3>Procesos</h3>
    <div id="process-list">
        </div>
    <button class="btn btn-add" onclick="addProcess()">+ Agregar Proceso</button>
    <button class="btn" onclick="runSimulation()">Calcular Round Robin</button>

    <div id="results-section" style="display:none;">
        <h2>Resultados</h2>
        
        <h3>Diagrama de Gantt</h3>
        <div class="gantt-container" id="gantt-chart"></div>

        <h3>Evolución de la Cola de Listos</h3>
        <p style="font-size: 0.9em; color: #666;">
            <span style="display:inline-block; width:10px; height:10px; background:#3498db"></span> CPU Inicial &nbsp;
            <span style="display:inline-block; width:10px; height:10px; background:#e67e22"></span> Par 1 &nbsp;
            <span style="display:inline-block; width:10px; height:10px; background:#9b59b6"></span> Par 2
        </p>
        <div class="trace-wrapper" id="trace-container"></div>

        <h3>Tabla de Tiempos</h3>
        <table id="results-table">
            <thead>
                <tr>
                    <th>Proceso</th>
                    <th>Llegada</th>
                    <th>Fin</th>
                    <th>Total E/S</th>
                    <th>TV (Vuelta)</th>
                    <th>TW (Espera)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="summary" id="averages"></div>
    </div>
</div>

<script>
    let processCount = 0;

    // Función para agregar un nuevo proceso
    function addProcess() {
        const div = document.createElement('div');
        div.className = 'process-box';
        
        // NUEVO DISEÑO HORIZONTAL
        div.innerHTML = `
            <div class="process-id">P${processCount}</div>
            <div style="flex: 1;">
                <label style="font-size:0.8em">Llegada (ms)</label>
                <input type="number" class="llegada" value="0">
            </div>
            <div style="flex: 4;">
                <label style="font-size:0.8em">Secuencia (Quantums):</label>
                <input type="text" class="rafagas" placeholder="Ej: 2, 2, 1" value="">
            </div>
            <button class="btn-del" onclick="this.parentElement.remove()">X</button>
        `;
        document.getElementById('process-list').appendChild(div);
        processCount++;
    }

    // Cargar datos por defecto
    window.onload = function() {
        addProcess(); // P0
        addProcess(); // P1
        addProcess(); // P2

        const boxes = document.querySelectorAll('.process-box');
        
        // P0
        boxes[0].querySelector('.llegada').value = 0;
        boxes[0].querySelector('.rafagas').value = "2, 2, 1, 2, 3";
        // P1
        boxes[1].querySelector('.llegada').value = 90;
        boxes[1].querySelector('.rafagas').value = "3, 2, 2";
        // P2
        boxes[2].querySelector('.llegada').value = 240;
        boxes[2].querySelector('.rafagas').value = "6";
    };

    async function runSimulation() {
        // 1. RECOLECCIÓN DE DATOS GENERALES
        const quantum = document.getElementById('quantum').value;
        const intercambio = document.getElementById('intercambio').value;
        const processDivs = document.querySelectorAll('.process-box');
    
        const procesos = [];

        // 2. PROCESAMIENTO DE CADA PROCESO
        processDivs.forEach((div) => {
            const pid = div.querySelector('.process-id').innerText; 
            const llegada = div.querySelector('.llegada').value;
            const rafagasText = div.querySelector('.rafagas').value;
            
            // --- LIMPIEZA DE DATOS ---
            // 1. split(','): Corta el texto por las comas -> ["2", " 2", " 1"]
            // 2. map(...): Convierte cada pedazo de texto a Número Entero
            // 3. filter(...): Elimina cualquier basura que no sea un número (por si ponen letras por error)
            const secuenciaArray = rafagasText.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));

            // Agregamos el objeto ordenado al arreglo 'procesos'
            procesos.push({
                pid: pid,
                llegada: llegada,
                secuencia_quantums: secuenciaArray
            });
        });

        // 3. COMUNICACIÓN CON EL SERVIDOR (PYTHON)
        // 'await fetch': Envía los datos a la ruta '/simular' de tu archivo app.py
        // Espera a que Python haga los cálculos y responda
        const response = await fetch('/simular', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ quantum, intercambio, procesos })
        });

        // 4. RECIBIR Y MOSTRAR RESULTADOS
        const data = await response.json();
        renderResults(data);
    }

    function renderResults(data) {
        // 1. PREPARACIÓN VISUAL
        document.getElementById('results-section').style.display = 'block';
        
        // --- BLOQUE 1: DIAGRAMA DE GANTT ---
        const ganttDiv = document.getElementById('gantt-chart');
        ganttDiv.innerHTML = ''; // Limpia cualquier diagrama anterior para no duplicar

        // Obtiene el tiempo final absoluto del último bloque para mostrarlo al final
        const totalDuration = data.gantt[data.gantt.length-1].fin;
        
        // Recorremos la lista de bloques de tiempo que nos envió Python
        data.gantt.forEach(block => {
            const duration = block.fin - block.inicio;
            if (duration === 0) return; // Si dura 0, no dibujamos nada
            
            // Creamos un DIV nuevo para este bloque de tiempo
            const el = document.createElement('div');

            // --- LÓGICA DE ESTILOS ---
            el.className = block.tipo === 'CPU' ? 'gantt-block gantt-cpu' : 'gantt-block gantt-ctx';
            el.style.width = block.tipo === 'CPU' ? '40px' : '30px'; // Aquí definimos el ancho visual: 40px para Procesos, 30px para Intercambios   
            el.innerText = block.tipo === 'CPU' ? block.pid : '/';
            el.title = `Inicio: ${block.inicio}, Fin: ${block.fin}`;
            
            const timeLabel = document.createElement('span');
            timeLabel.className = 'gantt-time';
            timeLabel.innerText = block.inicio;

            // Insertamos la etiqueta dentro del bloque y el bloque dentro del contenedor principal
            el.appendChild(timeLabel);
            ganttDiv.appendChild(el);
        });
        
        // Agregamos manualmente el número del tiempo final al extremo derecho del diagrama
        const finalTime = document.createElement('div');
        finalTime.style.position = 'relative';
        finalTime.innerHTML = `<span style="position:absolute; bottom: -10px; font-size:10px; margin-left: 5px;">${totalDuration}</span>`;
        ganttDiv.appendChild(finalTime);


        // --- BLOQUE 2: TRAZA (EVOLUCIÓN DE LA COLA) ---
        const traceDiv = document.getElementById('trace-container');
        traceDiv.innerHTML = '';
        
        // Recorremos los pasos de la cola que calculó Python
        data.trace.forEach(item => {
            const el = document.createElement('div');
            let colorClass = 'fase-other';
            if (item.fase === 0) colorClass = 'fase-0';
            else if (item.fase === 2) colorClass = 'fase-2';
            else if (item.fase === 4) colorClass = 'fase-4';
            else if (item.fase === 6) colorClass = 'fase-6';

            el.className = `trace-item ${colorClass}`;

            // Insertamos el HTML interno de la caja:
            // Arriba: Cuánto sale (restante)
            // Medio: Cuánto entró (actual)
            // Abajo: Nombre del proceso
            el.innerHTML = `
                <span class="trace-top">${item.sale}</span>
                <span class="trace-mid">${item.entra}</span>
                <span class="trace-bot">${item.pid}</span>
            `;
            traceDiv.appendChild(el);
        });


        // --- BLOQUE 3: TABLA DE DATOS ---
        const tbody = document.querySelector('#results-table tbody');
        tbody.innerHTML = '';

        // Recorremos los resultados calculados
        data.tabla.forEach(row => {

            // Construimos la fila de la tabla con los datos recibidos (Llegada, Fin, TV, W)
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><b>${row.pid}</b></td>
                <td>${row.llegada}</td>
                <td>${row.fin}</td>
                <td>${row.io_total}</td>
                <td><strong>${row.tv}</strong></td>
                <td><strong>${row.w}</strong></td>
            `;
            tbody.appendChild(tr); // Añadimos la fila a la tabla
        });

        // --- BLOQUE 4: PROMEDIOS ---
        // Insertamos los promedios generales al final
        document.getElementById('averages').innerHTML = `
            <strong>Tiempo Medio de Vuelta:</strong> ${data.promedios.tv} ms <br>
            <strong>Tiempo Medio de Espera:</strong> ${data.promedios.w} ms
        `;
    }
</script>
</body>
</html>